<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hacettepe Web GIS Portal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- TEMEL AYARLAR --- */
        :root {
            --primary-color: #e30a17; /* Hacettepe Kƒ±rmƒ±zƒ±sƒ± */
            --primary-dark: #b80812;
            --accent-color: #2c3e50;
            --bg-color: #f0f2f5;
            --text-color: #333;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --radius: 12px;
        }
        body { font-family: 'Poppins', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); }

        /* --- Gƒ∞Rƒ∞≈û EKRANI --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(44,62,80,0.9), rgba(227,10,23,0.8)), url('https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Hacettepe_University_Beytepe_Campus_Entrance.jpg/1200px-Hacettepe_University_Beytepe_Campus_Entrance.jpg');
            background-size: cover; background-position: center;
            z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .auth-box {
            background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 20px; width: 380px; text-align: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2); animation: fadeIn 0.6s ease-out;
        }
        .input-group { margin-bottom: 15px; }
        .input-group input, .input-group select {
            width: 100%; padding: 15px; border: 2px solid #e1e1e1; border-radius: 10px; box-sizing: border-box; outline: none; transition:0.3s;
        }
        .input-group input:focus { border-color: var(--primary-color); }
        .btn-primary {
            background: var(--primary-color); color: white; border: none; padding: 15px; width: 100%;
            border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.3s; margin-top: 10px;
        }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-secondary { background: transparent; color: #666; border: 2px solid #ddd; padding: 12px; width: 100%; border-radius: 10px; cursor: pointer; margin-top: 10px; }
        .link-text { color: var(--primary-color); cursor: pointer; display: block; margin-top: 20px; font-size: 0.9em; }

        /* --- ANA DASHBOARD --- */
        #main-app { display: none; max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        
        header {
            display: flex; justify-content: space-between; align-items: center; background: white; padding: 20px 30px;
            border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 30px; border-left: 5px solid var(--primary-color);
        }
        .logout-btn { background: #ffebee; color: var(--primary-color); border: none; padding: 10px 20px; border-radius: 30px; font-weight: 600; cursor: pointer; }

        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .card { background: white; border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); }
        
        /* Harita */
        #map { height: 550px; width: 100%; border-radius: var(--radius); z-index: 1; }
        
        /* CSS Animasyonu (Marker i√ßin) */
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(0, 0, 0, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 0, 0, 0); }
        }

        /* Not Listesi */
        ul#notes-list { list-style: none; padding: 0; }
        ul#notes-list li {
            background: #f8f9fa; margin-bottom: 12px; padding: 15px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #ddd;
        }
        ul#notes-list li a { background: var(--accent-color); color: white; text-decoration: none; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; }

        /* Admin Butonlarƒ± */
        .status-btn { width: 48%; padding: 15px; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; }
        .green { background: #28a745; } .red { background: #dc3545; }
        .hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="auth-box">
            <h2 style="color:#2c3e50; margin-bottom:5px;">Hacettepe Portal</h2>
            <p style="color:#777; font-size:0.9em; margin-bottom:20px;">Web GIS & K√ºt√ºphane Sistemi</p>
            
            <div id="login-form">
                <div class="input-group"><input type="text" id="l-user" placeholder="Kullanƒ±cƒ± Adƒ±"></div>
                <div class="input-group"><input type="password" id="l-pass" placeholder="≈ûifre"></div>
                <button class="btn-primary" onclick="login()">Giri≈ü Yap</button>
                <button class="btn-secondary" onclick="guestLogin()">Misafir Giri≈üi</button>
                <span class="link-text" onclick="showRegister()">Hesap Olu≈ütur</span>
            </div>

            <div id="register-form" class="hidden">
                <div class="input-group"><input type="text" id="r-user" placeholder="Kullanƒ±cƒ± Adƒ± Belirle"></div>
                <div class="input-group"><input type="password" id="r-pass" placeholder="≈ûifre Belirle"></div>
                <div class="input-group">
                    <select id="r-role">
                        <option value="student">√ñƒürenci</option>
                        <option value="admin">Akademisyen / Y√∂netici</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="register()">Kayƒ±t Ol</button>
                <span class="link-text" onclick="showLogin()">Giri≈ü Ekranƒ±na D√∂n</span>
            </div>
        </div>
    </div>

    <div id="main-app">
        <header>
            <h1 id="welcome-text" style="margin:0; font-size:1.5rem; color:#2c3e50;">üìç Hacettepe Web GIS</h1>
            <button class="logout-btn" onclick="location.reload()">√áƒ±kƒ±≈ü Yap</button>
        </header>

        <div class="dashboard-grid">
            <div class="card" style="padding:10px;">
                <div id="map"></div>
            </div>

            <div class="sidebar">
                
                <div id="admin-panel" class="card hidden" style="margin-bottom:20px;">
                    <h3>‚öôÔ∏è K√ºt√ºphane Durumu</h3>
                    <div style="display:flex; justify-content:space-between;">
                        <button class="status-btn green" onclick="setStatus('M√ºsait')">M√ºsait</button>
                        <button class="status-btn red" onclick="setStatus('Dolu')">Dolu</button>
                    </div>
                </div>

                <div id="student-panel" class="card hidden" style="margin-bottom:20px;">
                    <h3>üì§ Ders Notu Payla≈ü</h3>
                    <div style="margin-bottom:10px;"><input type="text" id="note-name" placeholder="Ders Adƒ±" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;"></div>
                    <div style="margin-bottom:10px;"><input type="text" id="note-link" placeholder="Link" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;"></div>
                    <button class="btn-primary" style="margin-top:0;" onclick="uploadNote()">Payla≈ü</button>
                </div>

                <div class="card">
                    <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">üìö Son Notlar</h3>
                    <ul id="notes-list"><li>Y√ºkleniyor...</li></ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;

        // AUTH
        function showRegister() { document.getElementById('login-form').classList.add('hidden'); document.getElementById('register-form').classList.remove('hidden'); }
        function showLogin() { document.getElementById('register-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); }

        async function register() {
            const u = document.getElementById('r-user').value; const p = document.getElementById('r-pass').value; const r = document.getElementById('r-role').value;
            if(!u || !p) return alert("Eksik bilgi!");
            try {
                const res = await fetch('http://localhost:3000/api/register', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p, role:r}) });
                const d = await res.json();
                if(d.error) alert(d.error); else { alert(d.message); showLogin(); }
            } catch(e) { alert("Sunucu hatasƒ±!"); }
        }

        async function login() {
            const u = document.getElementById('l-user').value; const p = document.getElementById('l-pass').value;
            try {
                const res = await fetch('http://localhost:3000/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p}) });
                const d = await res.json();
                if(d.success) startApp(d.user.role, d.user.username); else alert(d.error);
            } catch(e) { alert("Sunucu hatasƒ±!"); }
        }
        function guestLogin() { startApp('guest', 'Misafir'); }

        // APP LOGIC
        function startApp(role, username) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('welcome-text').innerHTML = `üìç Ho≈ügeldin, ${username}`;
            
            if(role === 'admin') document.getElementById('admin-panel').classList.remove('hidden');
            if(role === 'student') document.getElementById('student-panel').classList.remove('hidden');

            initMap();
            loadNotes();
        }

        function initMap() {
            if(map) return;

            // 1. Altlƒ±k Haritalar
            const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OSM' });
            const uydu = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '¬© Esri' });
            const karanlik = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '¬© CartoDB' });

            map = L.map('map', { center: [39.8676, 32.7373], zoom: 16, layers: [uydu] }); // Uydu ile ba≈üla

            // 2. Kontroller
            L.control.layers({ "Uydu": uydu, "Sokak": osm, "Karanlƒ±k": karanlik }).addTo(map);
            L.control.scale({ imperial: false, metric: true }).addTo(map);

            // 3. Veri √áekme
            fetch('http://localhost:3000/api/library').then(r => r.json()).then(data => {
                data.forEach(item => {
                    const g = JSON.parse(item.geom);
                    const color = item.status === 'M√ºsait' ? '#28a745' : '#dc3545';
                    
                    // Animasyonlu ƒ∞kon
                    const iconHtml = `<div style="background-color:${color}; width:20px; height:20px; border-radius:50%; border:3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5); animation: pulse 2s infinite;"></div>`;
                    const customIcon = L.divIcon({ className: 'custom-div-icon', html: iconHtml, iconSize: [24, 24], iconAnchor: [12, 12] });

                    L.marker([g.coordinates[1], g.coordinates[0]], {icon: customIcon}).addTo(map)
                    .bindPopup(`<div style="text-align:center;"><b>${item.name}</b><br>Durum: <b style="color:${color}">${item.status}</b></div>`).openPopup();
                });
            });
        }

        async function setStatus(s) {
            await fetch('http://localhost:3000/api/library/status', { method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status:s}) });
            alert("Durum g√ºncellendi!"); location.reload();
        }

        async function uploadNote() {
            const n = document.getElementById('note-name').value; const l = document.getElementById('note-link').value;
            if(!n || !l) return alert("Doldurunuz.");
            await fetch('http://localhost:3000/api/notes', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({lessonName:n, noteUrl:l}) });
            alert("Not payla≈üƒ±ldƒ±!"); document.getElementById('note-name').value=""; document.getElementById('note-link').value=""; loadNotes();
        }

        async function loadNotes() {
            const ul = document.getElementById('notes-list');
            try {
                const res = await fetch('http://localhost:3000/api/notes');
                const data = await res.json();
                ul.innerHTML = "";
                if(data.length === 0) { ul.innerHTML = "<li style='justify-content:center'>Hen√ºz not yok.</li>"; return; }
                data.forEach(note => {
                    let url = note.url.startsWith('http') ? note.url : 'http://' + note.url;
                    ul.innerHTML += `<li><div style="display:flex; align-items:center; gap:10px;"><span style="background:#e30a17; color:white; width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px;">D</span><b>${note.lesson_name}</b></div><a href="${url}" target="_blank">A√ß</a></li>`;
                });
            } catch(e) { ul.innerHTML = "<li>Hata olu≈ütu.</li>"; }
        }
    </script>
</body>
</html>